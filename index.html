<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø¥ØªÙ‚Ø§Ù†</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- Firebase -->
    <script type="module">
        // Firebase App (the core Firebase SDK)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAyTfVJ2sx-OGUx_ny1_W1QRvzkjA7_aAQ",
            authDomain: "itqan-platform-4b7cc.firebaseapp.com",
            projectId: "itqan-platform-4b7cc",
            storageBucket: "itqan-platform-4b7cc.appspot.com",
            messagingSenderId: "59657931493",
            appId: "1:59657931493:web:695e8fb4053156aad1220c",
            measurementId: "G-81TN8CX9ZH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ============================================
        // GLOBAL STATE
        // ============================================
        let platformData = { subjects: [], teachers: [], videos: [], files: [] };
        let currentUser = null;
        let isAdmin = false;

        // ============================================
        // FIRESTORE FUNCTIONS
        // ============================================
        async function loadData() {
            // Load subjects
            const subjectsSnap = await getDocs(collection(db, "subjects"));
            platformData.subjects = subjectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Load teachers
            const teachersSnap = await getDocs(collection(db, "teachers"));
            platformData.teachers = teachersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Load videos
            const videosSnap = await getDocs(collection(db, "videos"));
            platformData.videos = videosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Load files
            const filesSnap = await getDocs(collection(db, "files"));
            platformData.files = filesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function saveSubject(subject) {
            const docRef = doc(db, "subjects", subject.id || generateId());
            await setDoc(docRef, subject);
            await loadData();
        }

        async function saveTeacher(teacher) {
            const docRef = doc(db, "teachers", teacher.id || generateId());
            await setDoc(docRef, teacher);
            await loadData();
        }

        async function saveVideo(video) {
            const docRef = doc(db, "videos", video.id || generateId());
            await setDoc(docRef, video);
            await loadData();
        }

        async function saveFile(file) {
            const docRef = doc(db, "files", file.id || generateId());
            await setDoc(docRef, file);
            await loadData();
        }

        async function deleteSubject(id) {
            await deleteDoc(doc(db, "subjects", id));
            // Also delete related videos and files
            platformData.videos.filter(v => v.subjectId === id).forEach(async v => await deleteDoc(doc(db, "videos", v.id)));
            platformData.files.filter(f => f.subjectId === id).forEach(async f => await deleteDoc(doc(db, "files", f.id)));
            await loadData();
        }

        async function deleteTeacher(id) {
            await deleteDoc(doc(db, "teachers", id));
            // Remove teacherId from videos
            platformData.videos.filter(v => v.teacherId === id).forEach(async v => {
                const docRef = doc(db, "videos", v.id);
                await updateDoc(docRef, { teacherId: null });
            });
            await loadData();
        }

        async function deleteVideo(id) {
            await deleteDoc(doc(db, "videos", id));
            await loadData();
        }

        async function deleteFile(id) {
            await deleteDoc(doc(db, "files", id));
            await loadData();
        }

        function generateId() {
            return Math.random().toString(36).substring(2, 15);
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function handleLogin(role) {
            if (role === 'student') {
                currentUser = { name: "Ø·Ø§Ù„Ø¨ Ø¥ØªÙ‚Ø§Ù†", role: "student", avatar: "Ø·" };
                isAdmin = false;
            } else if (role === 'admin') {
                currentUser = { name: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø¹Ù…Ø±Ø§Ù†", role: "admin", avatar: "Ù…" };
                isAdmin = true;
                document.getElementById('admin-nav-item').classList.remove('d-none');
            }

            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('user-avatar').textContent = currentUser.avatar;

            showAlert(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}!`, 'success');
            updateStats();
            loadDashboardContent();
        }

        function handleAdminLogin() {
            const password = prompt("ğŸ” Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±:");
            if (password === "Omran#05") handleLogin('admin');
            else if (password !== null) showAlert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!", 'danger');
        }

        function logout() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) location.reload();
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-toast`;
            alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // ============================================
        // DATA DISPLAY FUNCTIONS (Dashboard)
        // ============================================
        function updateStats() {
            document.getElementById('stats-subjects').textContent = platformData.subjects.length;
            document.getElementById('stats-teachers').textContent = platformData.teachers.length;
            document.getElementById('stats-videos').textContent = platformData.videos.length;
            document.getElementById('stats-files').textContent = platformData.files.length;
        }

        async function loadDashboardContent() {
            await loadData();
            updateStats();
        }

        // ============================================
        // ADMIN ADD FUNCTIONS
        // ============================================
        async function adminAddSubject() {
            const name = document.getElementById('admin-subject-name').value.trim();
            const desc = document.getElementById('admin-subject-desc').value.trim();
            if (!name) return showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©', 'danger');

            const newSubject = { name, description: desc, created: new Date().toISOString() };
            await saveSubject(newSubject);
            showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        async function adminAddTeacher() {
            const name = document.getElementById('admin-teacher-name').value.trim();
            if (!name) return showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…', 'danger');
            const newTeacher = {
                name,
                specialty: document.getElementById('admin-teacher-specialty').value.trim(),
                email: document.getElementById('admin-teacher-email').value.trim(),
                description: document.getElementById('admin-teacher-desc').value.trim(),
                created: new Date().toISOString()
            };
            await saveTeacher(newTeacher);
            showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        async function adminAddVideo() {
            const title = document.getElementById('admin-video-title').value.trim();
            const youtubeId = document.getElementById('admin-video-id').value.trim();
            if (!title || !youtubeId) return showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙ…Ø¹Ø±Ù Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨', 'danger');

            const newVideo = {
                title, youtubeId,
                subjectId: document.getElementById('admin-video-subject').value || null,
                teacherId: document.getElementById('admin-video-teacher').value || null,
                views: 0,
                created: new Date().toISOString()
            };
            await saveVideo(newVideo);
            showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        async function adminAddFile() {
            const name = document.getElementById('admin-file-name').value.trim();
            const url = document.getElementById('admin-file-url').value.trim();
            if (!name || !url) return showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙˆØ±Ø§Ø¨Ø·Ù‡', 'danger');

            const newFile = {
                name, url,
                type: document.getElementById('admin-file-type').value,
                subjectId: document.getElementById('admin-file-subject').value || null,
                size: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                downloads: 0,
                created: new Date().toISOString()
            };
            await saveFile(newFile);
            showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ============================================
        // INITIALIZE APP
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
        });
    </script>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <button onclick="handleLogin('student')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø·Ø§Ù„Ø¨</button>
        <button onclick="handleAdminLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
    </div>

    <!-- APP -->
    <div id="app" style="display:none;">
        <header>
            <div id="user-avatar"></div>
            <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </header>

        <aside id="sidebar">
            <ul>
                <li id="admin-nav-item" class="d-none">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</li>
            </ul>
        </aside>

        <main class="main-content">
            <section id="dashboard" class="section active">
                <h2>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                <div>
                    <span id="stats-subjects">0</span> Ø§Ù„Ù…ÙˆØ§Ø¯
                    <span id="stats-teachers">0</span> Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
                    <span id="stats-videos">0</span> Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
                    <span id="stats-files">0</span> Ø§Ù„Ù…Ù„ÙØ§Øª
                </div>
            </section>
        </main>
    </div>
</body>
</html>
